{% extends 'base.html' %}

{% block title %}CodeScanAI - Scan{% endblock %}

{% block content %}
<div class="jumbotron">
    <h1>Scan Your Code</h1>
    <p class="lead">Configure your scan settings and start scanning your code for security vulnerabilities.</p>
</div>

<div class="row">
    <div class="col-lg-8">
        <div class="card shadow">
            <div class="card-header">
                <i class="fas fa-cog mr-2"></i> Scan Configuration
            </div>
            <div class="card-body">
                <form method="post" class="form" role="form">
                    {{ form.hidden_tag() }}

                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                {{ form.provider.label(class="form-label") }}
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fas fa-cloud"></i></span>
                                    {{ form.provider(class="form-select") }}
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                {{ form.model.label(class="form-label") }}
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fas fa-robot"></i></span>
                                    {{ form.model(class="form-control") }}
                                </div>
                                <small class="form-text text-muted">Default is Mistral-7B-Instruct-v0.3 for enhanced
                                    vulnerability detection.</small>
                            </div>
                        </div>
                    </div>

                    <div class="form-group mb-4">
                        {{ form.directory.label(class="form-label") }}
                        <div class="input-group">
                            <span class="input-group-text"><i class="fas fa-folder-open"></i></span>
                            {{ form.directory(class="form-control") }}
                            <button type="button" class="btn btn-outline-secondary" id="browse-directory-btn">
                                <i class="fas fa-folder"></i> Browse
                            </button>
                        </div>
                    </div>

                    <!-- Directory Browser Modal -->
                    <div class="modal fade" id="directory-browser-modal" tabindex="-1"
                        aria-labelledby="directory-browser-modal-label" aria-hidden="true">
                        <div class="modal-dialog modal-lg">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title" id="directory-browser-modal-label">Browse Directories</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"
                                        aria-label="Close"></button>
                                </div>
                                <div class="modal-body">
                                    <div class="mb-3">
                                        <label for="current-directory" class="form-label">Current Directory:</label>
                                        <input type="text" class="form-control" id="current-directory" readonly>
                                    </div>
                                    <div class="list-group" id="directory-list"
                                        style="max-height: 400px; overflow-y: auto;">
                                        <!-- Directory list will be populated here -->
                                    </div>
                                    <div id="directory-error" class="alert alert-danger mt-3" style="display: none;">
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary"
                                        data-bs-dismiss="modal">Cancel</button>
                                    <button type="button" class="btn btn-primary" id="select-directory-btn">Select
                                        Directory</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <h4 class="mb-3">Scan Options</h4>

                    <div class="form-group mb-4">
                        {{ form.scan_type.label(class="form-label") }}
                        <div class="input-group">
                            <span class="input-group-text"><i class="fas fa-search"></i></span>
                            {{ form.scan_type(class="form-select") }}
                        </div>
                        <small class="form-text text-muted">Choose the type of security scan to perform.</small>
                    </div>

                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="form-check mb-3">
                                {{ form.changes_only(class="form-check-input") }}
                                {{ form.changes_only.label(class="form-check-label") }}
                            </div>

                            <div class="form-check mb-3" id="sast-option" style="display: none;">
                                {{ form.sast(class="form-check-input") }}
                                {{ form.sast.label(class="form-check-label") }}
                            </div>

                            <div class="form-check mb-3">
                                {{ form.fix(class="form-check-input") }}
                                {{ form.fix.label(class="form-check-label") }}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-check mb-3">
                                {{ form.validate(class="form-check-input") }}
                                {{ form.validate.label(class="form-check-label") }}
                            </div>

                            <div class="form-check mb-3">
                                {{ form.create_pr(class="form-check-input") }}
                                {{ form.create_pr.label(class="form-check-label") }}
                            </div>

                            <div class="form-check mb-3">
                                {{ form.dashboard(class="form-check-input") }}
                                {{ form.dashboard.label(class="form-check-label") }}
                            </div>
                        </div>
                    </div>

                    <h4 class="mb-3">GitHub Integration</h4>
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                {{ form.github_token.label(class="form-label") }}
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fas fa-key"></i></span>
                                    {{ form.github_token(class="form-control") }}
                                </div>
                                <small class="form-text text-muted">Required only if creating a pull request.</small>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                {{ form.repo.label(class="form-label") }}
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fab fa-github"></i></span>
                                    {{ form.repo(class="form-control") }}
                                </div>
                                <small class="form-text text-muted">Required only if creating a pull request.</small>
                            </div>
                        </div>
                    </div>

                    <h4 class="mb-3">API Keys Configuration</h4>
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                {{ form.nvd_api_key.label(class="form-label") }}
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fas fa-shield-alt"></i></span>
                                    {{ form.nvd_api_key(class="form-control", placeholder="NVD API Key") }}
                                </div>
                                <small class="form-text text-muted">
                                    API key for the National Vulnerability Database to avoid rate limiting.
                                    <a href="https://nvd.nist.gov/developers/request-an-api-key" target="_blank">
                                        <i class="fas fa-external-link-alt"></i> Get a free API key
                                    </a>
                                </small>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                {{ form.huggingface_token.label(class="form-label") }}
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fas fa-robot"></i></span>
                                    {{ form.huggingface_token(class="form-control", placeholder="Hugging Face API Key")
                                    }}
                                </div>
                                <small class="form-text text-muted">
                                    API key for Hugging Face. Required for Llama models.
                                    <a href="https://huggingface.co/settings/tokens" target="_blank">
                                        <i class="fas fa-external-link-alt"></i> Get a free API key
                                    </a>
                                </small>
                            </div>
                        </div>
                    </div>

                    <div id="dast-section">
                        <h4 class="mb-3">DAST Configuration</h4>
                        <div class="row mb-4">
                            <div class="col-md-12">
                                <div class="form-group mb-3">
                                    {{ form.target_url.label(class="form-label") }}
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="fas fa-globe"></i></span>
                                        {{ form.target_url(class="form-control", placeholder="https://example.com") }}
                                    </div>
                                    <small class="form-text text-muted">
                                        URL of the web application to scan dynamically. Required for DAST scanning.
                                    </small>
                                </div>
                            </div>
                        </div>
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <div class="form-group mb-3">
                                    {{ form.zap_path.label(class="form-label") }}
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="fas fa-folder-open"></i></span>
                                        {{ form.zap_path(class="form-control", placeholder="Path to ZAP installation")
                                        }}
                                    </div>
                                    <small class="form-text text-muted">
                                        Optional. Leave empty for auto-detection. Common paths:
                                        <ul class="mt-1">
                                            <li>Windows: C:\Program Files\OWASP\Zed Attack Proxy</li>
                                            <li>Linux: /usr/share/zaproxy</li>
                                            <li>macOS: /Applications/OWASP ZAP.app/Contents/Java</li>
                                        </ul>
                                    </small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group mb-3">
                                    {{ form.zap_api_key.label(class="form-label") }}
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="fas fa-key"></i></span>
                                        {{ form.zap_api_key(class="form-control", placeholder="ZAP API Key") }}
                                    </div>
                                    <small class="form-text text-muted">
                                        Optional. Leave empty to generate a random key.
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="form-group mt-4 text-center">
                        {{ form.submit(class="btn btn-primary btn-lg") }}
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="col-lg-4">
        <div class="card shadow">
            <div class="card-header">
                <i class="fas fa-info-circle mr-2"></i> Scan Information
            </div>
            <div class="card-body">
                <p>Configure your scan settings to detect and fix security vulnerabilities in your code.</p>
                <p>The scan will analyze your code for common security issues and generate fixes using AI.</p>

                <div class="alert alert-info">
                    <i class="fas fa-lightbulb mr-2"></i> <strong>Tip:</strong> Enable all options for the most
                    comprehensive security analysis.
                </div>
            </div>
        </div>
    </div>
</div>

<div class="mt-5 mb-5">
    <h2 class="mb-4">Scan Options Explained</h2>
    <div class="accordion" id="scanOptionsAccordion">
        <div class="accordion-item shadow-sm">
            <h2 class="accordion-header" id="headingProvider">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                    data-bs-target="#collapseProvider" aria-expanded="false" aria-controls="collapseProvider">
                    <i class="fas fa-cloud mr-2"></i> AI Provider
                </button>
            </h2>
            <div id="collapseProvider" class="accordion-collapse collapse" aria-labelledby="headingProvider"
                data-bs-parent="#scanOptionsAccordion">
                <div class="accordion-body">
                    <p>Select the AI provider to use for scanning your code. Options include:</p>
                    <div class="row mt-3">
                        <div class="col-md-6">
                            <div class="card mb-3">
                                <div class="card-body">
                                    <h5><i class="fas fa-brain text-primary mr-2"></i> OpenAI</h5>
                                    <p>Uses OpenAI's models for advanced code analysis (requires API key)</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card mb-3">
                                <div class="card-body">
                                    <h5><i class="fab fa-google text-danger mr-2"></i> Google Gemini</h5>
                                    <p>Uses Google's Gemini models for code scanning (requires API key)</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card mb-3">
                                <div class="card-body">
                                    <h5><i class="fas fa-robot text-success mr-2"></i> Hugging Face</h5>
                                    <p>Uses Hugging Face's models for code analysis (some are free)</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card mb-3">
                                <div class="card-body">
                                    <h5><i class="fas fa-server text-info mr-2"></i> Custom AI Server</h5>
                                    <p>Uses a custom AI server for specialized code scanning</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="accordion-item shadow-sm">
            <h2 class="accordion-header" id="headingScanType">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                    data-bs-target="#collapseScanType" aria-expanded="false" aria-controls="collapseScanType">
                    <i class="fas fa-search mr-2"></i> Scan Types
                </button>
            </h2>
            <div id="collapseScanType" class="accordion-collapse collapse" aria-labelledby="headingScanType"
                data-bs-parent="#scanOptionsAccordion">
                <div class="accordion-body">
                    <p>CodeScanAI offers two complementary security scanning approaches:</p>
                    <div class="row mt-3">
                        <div class="col-md-6">
                            <div class="card h-100">
                                <div class="card-header bg-primary text-white">
                                    <i class="fas fa-shield-alt mr-2"></i> SAST (Static Application Security Testing)
                                </div>
                                <div class="card-body">
                                    <p>Analyzes your source code for security vulnerabilities without executing it.</p>
                                    <h6>Detects:</h6>
                                    <ul>
                                        <li>SQL injection vulnerabilities</li>
                                        <li>Cross-site scripting (XSS)</li>
                                        <li>Command injection</li>
                                        <li>Hardcoded credentials</li>
                                        <li>Insecure cryptographic functions</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card h-100">
                                <div class="card-header bg-success text-white">
                                    <i class="fas fa-box-open mr-2"></i> SCA (Software Composition Analysis)
                                </div>
                                <div class="card-body">
                                    <p>Analyzes your project dependencies for known security vulnerabilities.</p>
                                    <h6>Detects:</h6>
                                    <ul>
                                        <li>Vulnerable third-party libraries</li>
                                        <li>Outdated dependencies</li>
                                        <li>Known CVEs in packages</li>
                                        <li>License compliance issues</li>
                                        <li>Supply chain risks</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-md-12">
                            <div class="card h-100">
                                <div class="card-header bg-danger text-white">
                                    <i class="fas fa-spider mr-2"></i> DAST (Dynamic Application Security Testing)
                                </div>
                                <div class="card-body">
                                    <p>Actively tests running web applications to find security vulnerabilities during
                                        execution.</p>
                                    <h6>Detects:</h6>
                                    <ul>
                                        <li>Authentication issues</li>
                                        <li>Cross-site scripting (XSS) in rendered pages</li>
                                        <li>SQL injection in live endpoints</li>
                                        <li>CSRF vulnerabilities</li>
                                        <li>Security misconfigurations</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="alert alert-info mt-3">
                        <i class="fas fa-info-circle mr-2"></i> <strong>Recommendation:</strong> For comprehensive
                        security coverage, select "All (SAST, SCA & DAST)" to identify code-level vulnerabilities,
                        vulnerable dependencies, and runtime security issues.
                    </div>
                </div>
            </div>
        </div>

        <div class="accordion-item shadow-sm">
            <h2 class="accordion-header" id="headingSAST">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                    data-bs-target="#collapseSAST" aria-expanded="false" aria-controls="collapseSAST">
                    <i class="fas fa-shield-alt mr-2"></i> SAST Scanning
                </button>
            </h2>
            <div id="collapseSAST" class="accordion-collapse collapse" aria-labelledby="headingSAST"
                data-bs-parent="#scanOptionsAccordion">
                <div class="accordion-body">
                    <p>Static Application Security Testing (SAST) scans your code for security vulnerabilities without
                        executing it.</p>
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle mr-2"></i> CodeScanAI uses Bandit for Python code scanning and
                        other specialized scanners for different languages.
                    </div>
                    <h5 class="mt-3">Detects issues like:</h5>
                    <div class="row mt-3">
                        <div class="col-md-6">
                            <ul class="list-group">
                                <li class="list-group-item"><i class="fas fa-key text-danger mr-2"></i> Hardcoded
                                    passwords</li>
                                <li class="list-group-item"><i class="fas fa-database text-warning mr-2"></i> SQL
                                    injection vulnerabilities</li>
                                <li class="list-group-item"><i class="fas fa-terminal text-danger mr-2"></i> Command
                                    injection vulnerabilities</li>
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <ul class="list-group">
                                <li class="list-group-item"><i class="fas fa-lock text-warning mr-2"></i> Insecure
                                    cryptographic functions</li>
                                <li class="list-group-item"><i class="fas fa-file-code text-info mr-2"></i> Cross-site
                                    scripting (XSS)</li>
                                <li class="list-group-item"><i class="fas fa-folder-open text-warning mr-2"></i> Path
                                    traversal vulnerabilities</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="accordion-item shadow-sm">
            <h2 class="accordion-header" id="headingSCA">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                    data-bs-target="#collapseSCA" aria-expanded="false" aria-controls="collapseSCA">
                    <i class="fas fa-box-open mr-2"></i> SCA Scanning
                </button>
            </h2>
            <div id="collapseSCA" class="accordion-collapse collapse" aria-labelledby="headingSCA"
                data-bs-parent="#scanOptionsAccordion">
                <div class="accordion-body">
                    <p>Software Composition Analysis (SCA) scans your project dependencies for known security
                        vulnerabilities.</p>
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle mr-2"></i> CodeScanAI analyzes dependency files like package.json,
                        requirements.txt, pom.xml, and more. The Mistral AI model enhances detection capabilities.
                    </div>
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle mr-2"></i> <strong>Note:</strong> For best results,
                        provide an
                        <strong>NVD API Key</strong> in the SCA Configuration section to avoid rate limiting from the
                        National
                        Vulnerability Database.
                    </div>
                    <h5 class="mt-3">Key Features:</h5>
                    <div class="row mt-3">
                        <div class="col-md-6">
                            <div class="card mb-3">
                                <div class="card-body">
                                    <h6><i class="fas fa-search text-primary mr-2"></i> Vulnerability Detection</h6>
                                    <p>Identifies known vulnerabilities (CVEs) in your dependencies by checking against
                                        security databases.</p>
                                </div>
                            </div>
                            <div class="card mb-3">
                                <div class="card-body">
                                    <h6><i class="fas fa-code-branch text-success mr-2"></i> Version Analysis</h6>
                                    <p>Detects outdated dependencies and suggests secure version upgrades.</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card mb-3">
                                <div class="card-body">
                                    <h6><i class="fas fa-project-diagram text-info mr-2"></i> Dependency Mapping</h6>
                                    <p>Creates a dependency tree to understand the relationships between packages.</p>
                                </div>
                            </div>
                            <div class="card mb-3">
                                <div class="card-body">
                                    <h6><i class="fas fa-file-contract text-warning mr-2"></i> License Analysis</h6>
                                    <p>Identifies potential license compliance issues in your dependencies.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="accordion-item shadow-sm">
            <h2 class="accordion-header" id="headingDAST">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                    data-bs-target="#collapseDAST" aria-expanded="false" aria-controls="collapseDAST">
                    <i class="fas fa-spider mr-2"></i> DAST Scanning
                </button>
            </h2>
            <div id="collapseDAST" class="accordion-collapse collapse" aria-labelledby="headingDAST"
                data-bs-parent="#scanOptionsAccordion">
                <div class="accordion-body">
                    <p>Dynamic Application Security Testing (DAST) actively tests running web applications to find
                        security vulnerabilities during execution.</p>
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle mr-2"></i> CodeScanAI uses OWASP ZAP (Zed Attack Proxy) for dynamic
                        scanning of web applications.
                    </div>
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle mr-2"></i> <strong>Requirements:</strong> You must provide
                        a target URL in the DAST Configuration section.
                    </div>
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle mr-2"></i> <strong>ZAP Installation:</strong> For full DAST
                        capabilities, install <a href="https://www.zaproxy.org/download/" target="_blank">OWASP ZAP</a>.
                        If ZAP is not found, a basic scanner will be used instead.
                    </div>
                    <h5 class="mt-3">Key Features:</h5>
                    <div class="row mt-3">
                        <div class="col-md-6">
                            <div class="card mb-3">
                                <div class="card-body">
                                    <h6><i class="fas fa-spider text-danger mr-2"></i> Active Scanning</h6>
                                    <p>Actively probes the application with various attack patterns to identify
                                        vulnerabilities.</p>
                                </div>
                            </div>
                            <div class="card mb-3">
                                <div class="card-body">
                                    <h6><i class="fas fa-sitemap text-success mr-2"></i> Site Crawling</h6>
                                    <p>Automatically discovers and maps the structure of the web application.</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card mb-3">
                                <div class="card-body">
                                    <h6><i class="fas fa-shield-alt text-info mr-2"></i> OWASP Top 10 Coverage</h6>
                                    <p>Detects vulnerabilities from the OWASP Top 10 list of web application security
                                        risks.</p>
                                </div>
                            </div>
                            <div class="card mb-3">
                                <div class="card-body">
                                    <h6><i class="fas fa-file-alt text-warning mr-2"></i> Detailed Reports</h6>
                                    <p>Provides detailed reports with vulnerability descriptions and remediation advice.
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="accordion-item shadow-sm">
            <h2 class="accordion-header" id="headingFix">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                    data-bs-target="#collapseFix" aria-expanded="false" aria-controls="collapseFix">
                    <i class="fas fa-wrench mr-2"></i> Generate Fixes
                </button>
            </h2>
            <div id="collapseFix" class="accordion-collapse collapse" aria-labelledby="headingFix"
                data-bs-parent="#scanOptionsAccordion">
                <div class="accordion-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h5>How it works:</h5>
                            <ol class="list-group list-group-numbered mb-3">
                                <li class="list-group-item">AI analyzes the vulnerable code</li>
                                <li class="list-group-item">Identifies the security issue pattern</li>
                                <li class="list-group-item">Generates a secure code fix</li>
                                <li class="list-group-item">Ensures code functionality is preserved</li>
                            </ol>
                        </div>
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header bg-success text-white">
                                    <i class="fas fa-check-circle mr-2"></i> Benefits
                                </div>
                                <div class="card-body">
                                    <ul class="mb-0">
                                        <li>Saves developer time</li>
                                        <li>Reduces security risks</li>
                                        <li>Educates on secure coding practices</li>
                                        <li>Improves code quality</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="accordion-item shadow-sm">
            <h2 class="accordion-header" id="headingValidate">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                    data-bs-target="#collapseValidate" aria-expanded="false" aria-controls="collapseValidate">
                    <i class="fas fa-check-circle mr-2"></i> Validate Fixes
                </button>
            </h2>
            <div id="collapseValidate" class="accordion-collapse collapse" aria-labelledby="headingValidate"
                data-bs-parent="#scanOptionsAccordion">
                <div class="accordion-body">
                    <p>When enabled, CodeScanAI will validate the generated fixes through multiple methods:</p>
                    <div class="row mt-3">
                        <div class="col-md-4">
                            <div class="card h-100">
                                <div class="card-body text-center">
                                    <i class="fas fa-code text-primary" style="font-size: 2rem;"></i>
                                    <h5 class="mt-3">Static Analysis</h5>
                                    <p>Analyzes the fix code for security patterns</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card h-100">
                                <div class="card-body text-center">
                                    <i class="fas fa-vial text-success" style="font-size: 2rem;"></i>
                                    <h5 class="mt-3">Test Cases</h5>
                                    <p>Runs test cases against the fix to verify security</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card h-100">
                                <div class="card-body text-center">
                                    <i class="fas fa-search text-info" style="font-size: 2rem;"></i>
                                    <h5 class="mt-3">Re-scanning</h5>
                                    <p>Re-scans the code to ensure vulnerabilities are resolved</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="accordion-item shadow-sm">
            <h2 class="accordion-header" id="headingPR">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                    data-bs-target="#collapsePR" aria-expanded="false" aria-controls="collapsePR">
                    <i class="fas fa-code-branch mr-2"></i> Create Pull Request
                </button>
            </h2>
            <div id="collapsePR" class="accordion-collapse collapse" aria-labelledby="headingPR"
                data-bs-parent="#scanOptionsAccordion">
                <div class="accordion-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h5>Automated PR Creation</h5>
                            <p>When enabled, CodeScanAI will:</p>
                            <ol>
                                <li>Create a new branch with fixes</li>
                                <li>Commit the changes with detailed messages</li>
                                <li>Create a pull request with vulnerability details</li>
                                <li>Add labels and assignees as needed</li>
                            </ol>
                        </div>
                        <div class="col-md-6">
                            <div class="alert alert-warning">
                                <i class="fas fa-exclamation-triangle mr-2"></i> <strong>Requirements:</strong>
                                <ul class="mb-0 mt-2">
                                    <li>GitHub token with repo scope</li>
                                    <li>Repository name in format owner/repo</li>
                                    <li>Write access to the repository</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="accordion-item shadow-sm">
            <h2 class="accordion-header" id="headingDashboard">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                    data-bs-target="#collapseDashboard" aria-expanded="false" aria-controls="collapseDashboard">
                    <i class="fas fa-chart-line mr-2"></i> Show Dashboard
                </button>
            </h2>
            <div id="collapseDashboard" class="accordion-collapse collapse" aria-labelledby="headingDashboard"
                data-bs-parent="#scanOptionsAccordion">
                <div class="accordion-body">
                    <p>When enabled, CodeScanAI will generate a comprehensive security metrics dashboard.</p>
                    <div class="row mt-3">
                        <div class="col-md-6">
                            <h5>Dashboard Features:</h5>
                            <ul class="list-group">
                                <li class="list-group-item d-flex align-items-center">
                                    <i class="fas fa-chart-pie text-primary mr-2"></i> Vulnerability distribution by
                                    severity
                                </li>
                                <li class="list-group-item d-flex align-items-center">
                                    <i class="fas fa-chart-bar text-success mr-2"></i> Fix success rate metrics
                                </li>
                                <li class="list-group-item d-flex align-items-center">
                                    <i class="fas fa-code text-info mr-2"></i> Vulnerability types breakdown
                                </li>
                                <li class="list-group-item d-flex align-items-center">
                                    <i class="fas fa-history text-warning mr-2"></i> Historical security trends
                                </li>
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header bg-primary text-white">
                                    <i class="fas fa-chart-line mr-2"></i> Benefits
                                </div>
                                <div class="card-body">
                                    <ul>
                                        <li>Visualize security posture</li>
                                        <li>Track improvement over time</li>
                                        <li>Identify recurring issues</li>
                                        <li>Generate security reports</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Get elements
        const browseDirectoryBtn = document.getElementById('browse-directory-btn');
        const directoryBrowserModal = new bootstrap.Modal(document.getElementById('directory-browser-modal'));
        const currentDirectoryInput = document.getElementById('current-directory');
        const directoryList = document.getElementById('directory-list');
        const directoryError = document.getElementById('directory-error');
        const selectDirectoryBtn = document.getElementById('select-directory-btn');
        const directoryField = document.getElementById('directory');

        // Handle scan type selection
        const scanTypeSelect = document.getElementById('scan_type');
        const sastCheckbox = document.getElementById('sast');

        // Get DAST configuration elements
        const dastConfigHeading = document.querySelector('h4.mb-3');
        const dastConfigElements = document.querySelectorAll('.form-group');
        const targetUrlField = document.getElementById('target_url');

        // Function to update scan options based on scan type
        function updateScanOptions() {
            const scanType = scanTypeSelect.value;

            // Set SAST checkbox based on scan type
            if (scanType === 'all' || scanType === 'both' || scanType === 'sast') {
                sastCheckbox.checked = true;
            } else {
                sastCheckbox.checked = false;
            }

            // Hide the SAST option since it's controlled by the scan type dropdown
            document.getElementById('sast-option').style.display = 'none';

            // Show/hide DAST configuration based on scan type
            if (scanType === 'all' || scanType === 'dast') {
                // Show DAST configuration
                const dastSection = document.getElementById('dast-section');
                if (dastSection) {
                    dastSection.style.display = 'block';
                }

                // Make target URL required
                if (targetUrlField) {
                    targetUrlField.required = true;
                }
            } else {
                // Hide DAST configuration
                const dastSection = document.getElementById('dast-section');
                if (dastSection) {
                    dastSection.style.display = 'none';
                }

                // Make target URL not required
                if (targetUrlField) {
                    targetUrlField.required = false;
                }
            }
        }

        // Initialize scan options
        updateScanOptions();

        // Add event listener for scan type changes
        scanTypeSelect.addEventListener('change', updateScanOptions);

        // Initialize with the current directory value or home directory
        let currentDirectory = directoryField.value || '~';

        // Function to load directories
        function loadDirectories(directory) {
            // Show loading indicator
            directoryList.innerHTML = '<div class="text-center p-3"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div></div>';
            directoryError.style.display = 'none';

            // Make API request to get directories
            fetch(`/browse_directory?dir=${encodeURIComponent(directory)}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Update current directory
                        currentDirectory = data.current_dir;
                        currentDirectoryInput.value = currentDirectory;

                        // Clear directory list
                        directoryList.innerHTML = '';

                        // Add directories to the list
                        if (data.directories.length === 0) {
                            directoryList.innerHTML = '<div class="text-center p-3">No directories found</div>';
                        } else {
                            data.directories.forEach(dir => {
                                const item = document.createElement('button');
                                item.className = 'list-group-item list-group-item-action d-flex align-items-center';
                                item.type = 'button';

                                // Add icon
                                const icon = document.createElement('i');
                                icon.className = 'fas fa-folder me-2';
                                item.appendChild(icon);

                                // Add directory name
                                const text = document.createTextNode(dir.name);
                                item.appendChild(text);

                                // Add click event
                                item.addEventListener('click', function () {
                                    loadDirectories(dir.path);
                                });

                                directoryList.appendChild(item);
                            });
                        }
                    } else {
                        // Show error
                        directoryError.textContent = data.error || 'Failed to load directories';
                        directoryError.style.display = 'block';
                    }
                })
                .catch(error => {
                    // Show error
                    directoryError.textContent = `Error: ${error.message}`;
                    directoryError.style.display = 'block';
                    directoryList.innerHTML = '';
                });
        }

        // Open directory browser
        browseDirectoryBtn.addEventListener('click', function () {
            // Load directories
            loadDirectories(directoryField.value || '~');

            // Show modal
            directoryBrowserModal.show();
        });

        // Select directory
        selectDirectoryBtn.addEventListener('click', function () {
            // Set directory field value
            directoryField.value = currentDirectory;

            // Hide modal
            directoryBrowserModal.hide();
        });
    });
</script>
{% endblock %}